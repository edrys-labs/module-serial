<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="A WebSerial module for live serial comms with stations" />
    <meta name="show-in" content="station" />
    <title>Live WebSerial</title>

    <script src="https://edrys-org.github.io/edrys/module/edrys.js"></script>

    <script defer src="https://edrys-org.github.io/edrys/module/vendor/alpine.min.js"></script>
    <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/water.min.css" />
    <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/open-iconic/css/open-iconic.min.css" />

    <script src="./xterm/xterm.min.js"></script>
    <link rel="stylesheet" href="./xterm/xterm.min.css">
</head>

<body>
    <template x-if="!!edrys" x-data="{ edrys: undefined }" x-init="Edrys.onUpdate((e) => { edrys = {...e} })">
        <div x-show="edrys.role == 'station'" x-data="{ baudRate: 9600, connected: false }">
            <div x-show="!connected">
                <label for="baud">Baud Rate</label>
                <select id="baud" x-model="baudRate">
                    <option value="1200">1200</option>
                    <option value="2400">2400</option>
                    <option value="4800">4800</option>
                    <option value="9600">9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600">57600</option>
                    <option value="115200">115200</option>
                </select>
                <button
                    @click="async (e) => { await window.serial_connect(baudRate); connected = true }">Connect</button>
            </div>
            <div x-show="connected">
                <button @click="async (e) => { await window.serial_close(); connected = false }">Disconnect</button>
            </div>
        </div>
    </template>

    <div id="terminal"></div>

    <script type="module">
        import { FitAddon } from './xterm/xterm-addon-fit.js'
        console.log('run', window)
        var term = new Terminal()
        term.open(document.getElementById('terminal'));
        const fitAddon = new FitAddon();
        term.loadAddon(fitAddon);
        fitAddon.fit();

        term.onKey(e => {
            let text = e.key
            if (e.key == '\r') {
                text += '\n'
            }
            Edrys.sendMessage('w', text)
        })

        Edrys.onMessage(({ from, subject, body }) => {
            term.write(body)

            if (subject == 'w' && Edrys.role == 'station')
                write(body)
        })

        let port = null
        async function serial_connect(baudRate) {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: baudRate });
            serial_read()
        }
        window.serial_connect = serial_connect

        let reader = null
        let readableStreamClosed = null
        async function serial_read() {
            const textDecoder = new TextDecoderStream();
            readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    reader.releaseLock();
                    break;
                }
                Edrys.sendMessage("r", value);
            }
        }

        async function serial_close() {
            window.location.reload()
        }
        window.serial_close = serial_close

        let writer = null
        let writableStreamClosed = null
        async function serial_write(text) {
            const textEncoder = new TextEncoderStream();
            writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
            writer = textEncoder.writable.getWriter();
            await writer.write(text);
        }
    </script>

    <style>
        body,
        html,
        #terminal,
        .terminal {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
        }
    </style>
</body>

</html>